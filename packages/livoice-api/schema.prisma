// This file is automatically generated by Keystone, do not modify it manually.
// Modify your Keystone config when you want to change this.

datasource postgresql {
  url               = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
  provider          = "postgresql"
}

generator client {
  provider = "prisma-client-js"
}

model Chat {
  id           String        @id @default(cuid())
  title        String        @default("AI chat")
  org          Organization? @relation("Chat_org", fields: [orgId], references: [id])
  orgId        String?       @map("org")
  project      Project?      @relation("Chat_project", fields: [projectId], references: [id])
  projectId    String?       @map("project")
  transcript   Transcript?   @relation("Chat_transcript", fields: [transcriptId], references: [id])
  transcriptId String?       @map("transcript")
  messages     ChatMessage[] @relation("ChatMessage_chat")
  createdAt    DateTime?     @default(now())
  updatedAt    DateTime?     @updatedAt

  @@index([orgId])
  @@index([projectId])
  @@index([transcriptId])
}

model ChatMessage {
  id        String              @id @default(cuid())
  chat      Chat?               @relation("ChatMessage_chat", fields: [chatId], references: [id])
  chatId    String?             @map("chat")
  role      String              @default("user")
  content   String              @default("")
  segments  TranscriptSegment[] @relation("ChatMessage_segments")
  createdAt DateTime?           @default(now())

  @@index([chatId])
}

model Organization {
  id              String       @id @default(cuid())
  name            String       @default("")
  autojoinDomains Json?        @default("[]")
  users           User[]       @relation("User_org")
  projects        Project[]    @relation("Project_org")
  transcripts     Transcript[] @relation("Transcript_org")
  chats           Chat[]       @relation("Chat_org")
}

model Project {
  id          String        @id @default(cuid())
  name        String        @default("")
  description String        @default("")
  org         Organization? @relation("Project_org", fields: [orgId], references: [id])
  orgId       String?       @map("org")
  transcripts Transcript[]  @relation("Transcript_project")
  chats       Chat[]        @relation("Chat_project")

  @@index([orgId])
}

model Transcript {
  id              String              @id @default(cuid())
  title           String              @default("")
  intervieweeName String              @default("")
  sourceUrl       String              @default("")
  language        String              @default("")
  notes           String              @default("")
  project         Project?            @relation("Transcript_project", fields: [projectId], references: [id])
  projectId       String?             @map("project")
  org             Organization?       @relation("Transcript_org", fields: [orgId], references: [id])
  orgId           String?             @map("org")
  segments        TranscriptSegment[] @relation("TranscriptSegment_transcript")
  chats           Chat[]              @relation("Chat_transcript")
  createdAt       DateTime?           @default(now())
  updatedAt       DateTime?           @updatedAt

  @@index([projectId])
  @@index([orgId])
}

model TranscriptSegment {
  id           String                       @id @default(cuid())
  transcript   Transcript?                  @relation("TranscriptSegment_transcript", fields: [transcriptId], references: [id])
  transcriptId String?                      @map("transcript")
  index        Int?
  startMs      Int?
  endMs        Int?
  durationMs   Int?
  text         String                       @default("")
  speaker      String                       @default("")
  isMetadata   Boolean                      @default(false)
  chatMessages ChatMessage[]                @relation("ChatMessage_segments")
  embedding    Unsupported("vector(1536)")?

  @@index([transcriptId])
  @@index([embedding], map: "TranscriptSegment_embedding_idx")
}

model User {
  id                String           @id @default(cuid())
  avatarSocialUrl   String           @default("")
  avatarUploaded    Json?
  email             String           @default("")
  firstName         String           @default("")
  lastName          String           @default("")
  role              UserRoleType?    @default(USER)
  providerAccountId String           @unique @default("")
  provider          UserProviderType @default(google)
  rawAuth           Json?
  org               Organization?    @relation("User_org", fields: [orgId], references: [id])
  orgId             String?          @map("org")
  isActive          Boolean          @default(true)
  createdAt         DateTime?        @default(now())
  provisionedAt     DateTime?
  updatedAt         DateTime?        @updatedAt
  seenAt            DateTime?

  @@index([email])
  @@index([orgId])
}

enum UserRoleType {
  USER
  ORG_ADMIN
  ORG_OWNER
  GOD
}

enum UserProviderType {
  google
}
