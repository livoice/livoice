// This file is automatically generated by Keystone, do not modify it manually.
// Modify your Keystone config when you want to change this.

datasource postgresql {
  url               = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
  provider          = "postgresql"
}

generator client {
  provider = "prisma-client-js"
}

model Chat {
  id           String        @id @default(cuid())
  title        String        @default("AI chat")
  systemPrompt String        @default("")
  org          Organization? @relation("Chat_org", fields: [orgId], references: [id])
  orgId        String?       @map("org")
  project      Project?      @relation("Chat_project", fields: [projectId], references: [id])
  projectId    String?       @map("project")
  messages     ChatMessage[] @relation("ChatMessage_chat")
  createdAt    DateTime?     @default(now())
  updatedAt    DateTime?     @updatedAt

  @@index([orgId])
  @@index([projectId])
}

model ChatMessage {
  id        String              @id @default(cuid())
  chat      Chat?               @relation("ChatMessage_chat", fields: [chatId], references: [id])
  chatId    String?             @map("chat")
  role      String              @default("user")
  content   String              @default("")
  segments  TranscriptSegment[] @relation("ChatMessage_segments")
  createdAt DateTime?           @default(now())

  @@index([chatId])
}

model Organization {
  id              String       @id @default(cuid())
  name            String       @default("")
  autojoinDomains Json?        @default("[]")
  users           User[]       @relation("User_org")
  projects        Project[]    @relation("Project_org")
  transcripts     Transcript[] @relation("Transcript_org")
  sources         Source[]     @relation("Source_org")
  chats           Chat[]       @relation("Chat_org")
}

model Project {
  id          String        @id @default(cuid())
  name        String        @default("")
  description String        @default("")
  org         Organization? @relation("Project_org", fields: [orgId], references: [id])
  orgId       String?       @map("org")
  sources     Source[]      @relation("Project_sources")
  chats       Chat[]        @relation("Chat_project")

  @@index([orgId])
}

model Source {
  id                   String                  @id @default(cuid())
  type                 SourceTypeType
  name                 String                  @default("")
  url                  String                  @default("")
  externalId           String                  @unique @default("")
  importStatus         SourceImportStatusType? @default(idle)
  importStartedAt      DateTime?
  importCompletedAt    DateTime?
  importCronExpression String                  @default("")
  importHistory        Json?
  org                  Organization?           @relation("Source_org", fields: [orgId], references: [id])
  orgId                String?                 @map("org")
  transcripts          Transcript[]            @relation("Transcript_source")
  projects             Project[]               @relation("Project_sources")

  @@index([orgId])
}

model Transcript {
  id                String                         @id @default(cuid())
  title             String                         @default("")
  intervieweeName   String                         @default("")
  sourceUrl         String                         @default("")
  language          String                         @default("")
  notes             String                         @default("")
  externalId        String                         @default("")
  publishedAt       DateTime?
  duration          Int?
  thumbnailUrl      String                         @default("")
  embeddingStatus   TranscriptEmbeddingStatusType? @default(pending)
  embeddingAttempts Int?                           @default(0)
  embeddingError    String                         @default("")
  embeddingAt       DateTime?
  importStatus      TranscriptImportStatusType?    @default(pending)
  importAttempts    Int?                           @default(0)
  importError       String                         @default("")
  importAt          DateTime?
  source            Source?                        @relation("Transcript_source", fields: [sourceId], references: [id])
  sourceId          String?                        @map("source")
  org               Organization?                  @relation("Transcript_org", fields: [orgId], references: [id])
  orgId             String?                        @map("org")
  segments          TranscriptSegment[]            @relation("TranscriptSegment_transcript")
  createdAt         DateTime?                      @default(now())
  updatedAt         DateTime?                      @updatedAt

  @@index([sourceId])
  @@index([orgId])
}

model TranscriptSegment {
  id           String                       @id @default(cuid())
  transcript   Transcript?                  @relation("TranscriptSegment_transcript", fields: [transcriptId], references: [id])
  transcriptId String?                      @map("transcript")
  index        Int?
  startMs      Int?
  endMs        Int?
  durationMs   Int?
  text         String                       @default("")
  speaker      String                       @default("")
  isMetadata   Boolean                      @default(false)
  chatMessages ChatMessage[]                @relation("ChatMessage_segments")
  embedding    Unsupported("vector(1536)")?

  @@index([transcriptId])
  @@index([embedding], map: "TranscriptSegment_embedding_idx")
}

model User {
  id                String           @id @default(cuid())
  avatarSocialUrl   String           @default("")
  avatarUploaded    Json?
  email             String           @default("")
  firstName         String           @default("")
  lastName          String           @default("")
  role              UserRoleType?    @default(USER)
  providerAccountId String           @unique @default("")
  provider          UserProviderType @default(google)
  rawAuth           Json?
  org               Organization?    @relation("User_org", fields: [orgId], references: [id])
  orgId             String?          @map("org")
  isActive          Boolean          @default(true)
  createdAt         DateTime?        @default(now())
  provisionedAt     DateTime?
  updatedAt         DateTime?        @updatedAt
  seenAt            DateTime?

  @@index([email])
  @@index([orgId])
}

enum SourceTypeType {
  youtube_channel
}

enum SourceImportStatusType {
  idle
  importing
  completed
  failed
}

enum TranscriptEmbeddingStatusType {
  pending
  processing
  completed
  failed
}

enum TranscriptImportStatusType {
  pending
  fetching
  completed
  failed
  skipped
}

enum UserRoleType {
  USER
  ORG_ADMIN
  ORG_OWNER
  GOD
}

enum UserProviderType {
  google
}
